<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>黑白图片上色工具</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .image-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .image-box {
            flex: 1;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        img {
            max-width: 100%;
            max-height: 400px;
            display: block;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            min-height: 100px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 10px 0;
        }
        .loading:after {
            content: " .";
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            40% { color: black; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); }
            60% { text-shadow: .25em 0 0 black, .5em 0 0 rgba(0,0,0,0); }
            80%, 100% { text-shadow: .25em 0 0 black, .5em 0 0 black; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>黑白图片上色工具</h1>

    <div>
        <input type="file" id="imageInput" accept="image/*">
        <button id="colorize-btn">上色图片</button>
    </div>

    <div class="loading" id="loading">处理中</div>

    <div class="image-container">
        <div class="image-box">
            <h3>原始图片</h3>
            <img id="originalImage" style="display:none">
        </div>
        <div class="image-box">
            <h3>上色结果</h3>
            <img id="colorizedImage" style="display:none">
        </div>
    </div>

    <div id="result"></div>
</div>

<script>
    // 图片预览
    $('#imageInput').change(function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                $('#originalImage').attr('src', event.target.result).show();
                $('#colorizedImage').hide();
            };
            reader.readAsDataURL(file);
        }
    });

    // 压缩图片
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 保持宽高比的情况下调整大小
                    const MAX_SIZE = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height *= MAX_SIZE / width;
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width *= MAX_SIZE / height;
                            height = MAX_SIZE;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                    resolve(base64);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // 图片上色
    async function colorizeImage() {
        const file = $('#imageInput')[0].files[0];

        if (!file) {
            $('#result').text('请选择一张图片');
            return;
        }

        $('#loading').show();
        $('#result').text('');
        $('#colorizedImage').hide();

        try {
            const imageBase64 = await compressImage(file);

            $.ajax({
                url: 'http://localhost:3001/image/colorize',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    image: {
                        image: imageBase64,
                        image_type: "BASE64"
                    }
                }),
                success: function(data) {
                    $('#loading').hide();
                    if (data.error_code) {
                        $('#result').text('错误: ' + (data.error_msg || '未知错误'));
                    } else if (data.image) {
                        $('#colorizedImage')
                            .attr('src', 'data:image/jpeg;base64,' + data.image)
                            .show();
                        $('#result').text('上色完成！');
                    } else {
                        $('#result').text('未能获取上色结果');
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    $('#result').text('请求失败: ' + error);
                }
            });
        } catch (error) {
            $('#loading').hide();
            $('#result').text('处理失败: ' + error.message);
        }
    }

    $('#colorize-btn').click(colorizeImage);
</script>
</body>
</html>
# 第七章 磁盘存储器的管理
## 7.1外存的组织方式
### 7.1.1连续组织
#### 连续分配方式（Continuous Allocation）
* 存储结构：文件分配一组连续的盘块
* 文件地址：第一盘块号和文件长度
* 外存碎片：通过紧缩将外存空闲空间合并成连续的区域
![pic1](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/7.1.1%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E8%BF%9E%E7%BB%AD%E5%88%86%E9%85%8D.png?raw=true)
### 7.1.2链接组织（Chained Allocation）
#### 存储结构
* 文件分配到离散的盘块中，通过链接指针
* 将这些离散的盘块链成一个链表。
#### 链接的形式
* 隐式链接：只适合顺序访问，随机访问极其低效。可靠性较差，只要其中的任何一个指针出现问题，都会导致整个链的断开。
* 显式链接：显著提高了检索速度，大大减少了访问磁盘的次数。由于分配给文件的所有盘块号都放在该表中，故该表有称为文件分配表(File Allocation Table)
### 7.1.3 FAT和NTFS技术
#### 以**盘块**为基本分配单位
* 整个系统有一张文件分配表FAT
* MS-DOS的文件的物理结构
#### FAT表占用存储空间的问题
* eg.在FAT12文件系统下，对1.2MB的软盘，盘块大小为512B，FAT中共含有2.4K个表项，由于每个FAT表项占12位，故FAT表占用3.6KB的存储空间
#### 簇
* 簇的基本概念：簇是一组连续的扇区
* 簇包含扇区的数量与磁盘容量的大小直接有关
#### FAT存在的问题
* FAT12所允许的磁盘容量存在着严重的限制
* FAT12只能支持8+3格式的文件名
* FAT16一般对1～4GB的硬盘来说，大约会浪费10％～20％的空间
![pic2](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/7.1.3MSDOS%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.png?raw=true)
### 7.1.4NTFS技术
#### 新特性
* 使用64位磁盘地址，理论上可支持2的64次方字节的磁盘分区
* 在NTFS中可以很好地支持长文件名，单个文件名限制在255个字符以内，全路径名为32 767个字符
* 具有系统容错功能: 出现故障或差错时，仍能保证系统正常运行
* 提供了数据的一致性
* 提供了文件加密、压缩等功能
#### NTFS磁盘组织
* 通过簇间接管理磁盘，不需要知道扇区的大小，使NTFS具有与磁盘物理扇区大小无关的独立性，很容易支持扇区大小不是512字节的非标准磁盘，从而可以根据不同的磁盘选择匹配的簇大小。 
* 卷上簇的大小称为“卷因子”，它是在磁盘格式化时确定的，其大小也是物理磁盘扇区的整数倍，即一个簇包含2n个盘块，簇的大可以为512B、1KB、2KB……64 KB
### 7.1.5索引组织（Index  Allocation）
#### NTFS存在的问题
* 不支持直接存取(FAT中顺序查找盘块号)
* FAT需占用较大的内存空间(只有将整个FAT调入内存，才能保证在FAT中找到文件的所有盘块号)
* **解决方法**：FAT部分调入内存（基于这种想法，形成索引分配方法）
#### 单级索引分配
* 支持高效的直接存取(索引表)
* 主要问题：花费较多的外存空间（小文件）
#### 多级索引分配
* 当文件盘块号装满一个索引块时，需要再分配另一个索引块，可通过链指针将各索引块按序链接起来。
* 当文件太大，其索引块太多，这种方法低效。
* 解决方法：为索引块建立索引，称为第一级索引，形成两级索引分配方式。如果文件非常大时，还可用三级、四级索引分配方式
#### 增量式(混合)分配方式
![pic3](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/7.1.5%E6%B7%B7%E5%90%88%E5%BC%8F%E5%88%86%E9%85%8D%E6%96%B9%E5%BC%8F.png?raw=true)
* 直接地址：在索引结点中可设置10个直接地址项，即用iaddr(0)～iaddr(9)来存放直接地址。假如盘块大小为4KB，当文件不大于40KB时，便可直接从索引结点中读出该文件的全部盘块号
* 一次间接地址：利用索引结点中的地址项iaddr(10)来提供一次间接地址(同二级索引：每个盘块号占4B,盘块个数1KB),。实质就是一级索引分配方式（大、中型文件，文件长达4 MB）
* 多次间接地址：文件大于4MB+40KB时，须采用二次间址分配方式。地址项iaddr(11)提供二次间接地址，实质是两级索引分配方式，此时文件最大长度可达4 GB。同理，地址项iaddr(12)作为三次间接地址，其所允许的文件最大长度可达4 TB
## 7.2文件存储空间的管理
### 7.2.1空闲表法和空闲链表法
#### 空闲表法
* 空闲表：外存每个空闲区对应一个空闲表项
* 空间的分配和回收（可采用多种方式，如首次适应算法、循环首次适应算法等）
### 7.2.2位示图法
#### 位示图
* 每一位表示一个块/簇，值0和1分别表示空闲和占用
* 占用空间少、容易找到相邻的空闲盘块
![pic4](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/7.2.2%E4%BD%8D%E7%A4%BA%E5%9B%BE%E6%B3%95.png?raw=true)
#### 盘块的分配(三步)  
* 顺序扫描位示图，找出一个/组值是0的二进制位
* 将找到的二进制位，转换成对应的盘块号
#### 盘块的回收(2步) 
* 将盘块号b转换成位于图中的行号和列号：i=(b-1) DIV n+1，j=(b-1) MOD n+1
* 修改位示图：map[i,j]= 0
### 7.2.3成组链接法
#### 空闲盘块的组织
* 所有空闲盘块，被分成若干个组，每组不超过N个。
* 每组含有的盘块总数N + 该组所有的盘块号，记入前一组的第一个盘块的S.free(0)~S.free(N-1)中。这个数组作为一个栈处理，栈顶是S.free(N-1)，栈底是S.free(0)。
* 第一组的盘块总数和所有盘块号，记入空闲盘块号栈，这个栈在内存中，软件可以直接操作。
* 最末一组只有N-1个盘块，盘块号记入其前一组第一盘块的S.free(1)~S.free(N-1)中。而在S.free(0)中存放“0”，作为空闲盘块链的结束标志。   
#### 空闲盘块的分配
* 通过在内存中的那个描述第一组的空闲盘块号栈，在这一组中分配所需要的空闲盘块。
* 如果这一组的空闲盘块已经分配完了，则将下一组的空闲盘块号栈送入内存中(这个栈在第一组的S.free(0)盘块中)。那么下一组就成了第一组。
* 重复以上两步操作，直到所需要的空闲盘块全部分配结束。   
#### 空闲盘块的回收
* 通过在内存中的那个空闲盘块号栈，在第一组中释放要回收的空闲盘块。
* 如果这一组的空闲盘块数已经满了，达到N个了，而且还没空闲盘块没有释放，则建立一个新的空闲盘块组，并将下一个空闲盘块作为新的组的第一个空闲盘块号，也就是S.free(0)。
* 将本组的空闲盘块号栈的数据放入新的空闲盘块的第一个空闲盘块中，并将新的空闲盘块组的空闲盘块号栈作为内存的空闲盘块号栈。
* 重复以上步骤，直到所需要的空闲盘块全部回收结束。
## 7.3提高磁盘I/O速度的途径
### 7.3.1磁盘高速缓存
### 7.3.2提高磁盘I/O速度的其他方法
* 提前读(Read-Ahead) 
* 延迟写
* 优化物理块的分布
* 虚拟盘
### 7.3.3廉价磁盘冗余阵列RAID
#### RAID
* 在该系统中，有多台磁盘驱动器，系统将每一盘块中的数据分为若干个子盘块数据，再把每一个子盘块的数据分别存储到各个不同磁盘中的相同位置上。以后，当要将一个盘块的数据传送到内存时，采取并行传输方式，将各个盘块中的子盘块数据同时向内存中传输，从而使传输时间大大减少。
#### RAID分级
* RAID 0 级：并行交叉存取
* RAID 1 级：具有磁盘镜像功能
* RAID 2 级：并行传输、奇偶校验功能
* RAID 5 级：独立传送、独立数据通道、校验信息螺旋分布
* RAID 6 级和 RAID 7 级
#### 优点
* 可靠性高。采用容错技术（RAID 0级除外）。当某一磁盘损坏时，不会造成数据的丢失，因为可通过磁盘镜像/磁盘双工/其它冗余方式恢复。
* 磁盘I/O速度高。采取并行交叉存取方式，可将磁盘I/O速度提高N-1倍(N为磁盘数目)。
* 性能/价格比高。利用RAID技术来实现大容量高速存储器时，其体积与具有相同容量和速度的大型磁盘系统相比，只是后者的1/3，价格也只是后者的1/3，且可靠性高。
## 7.4提高磁盘可靠性的技术
## 7.5数据一致性控制
### 7.5.1事务
* 用于访问和修改各个数据项的一个程序单位；被访问的数据可以分散在多个文件中，事务可看作是一系列读和写操作。 
* 当这些操作全部完成时，再以托付操作来终止事务。
* 只要有一项操作失败，则执行夭折操作       
### 7.5.2检查点
* 检查点作用：事务记录表中事务记录的清理工作经常化
### 7.5.3并发控制
* 重复文件的一致性：为保证文件系统的可用性，有些系统为关键文件设置了多个重复拷贝，将它们分别存储在不同的地方。
* 盘块号一致性的检查：盘块是用于存储文件的物理空间（空闲盘块表、FAT ）。每次启动时应检查这个数据结构，是否保持了数据的一致性。 
![pic6](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/7.5.4%E7%9B%98%E5%9D%97%E4%B8%80%E8%87%B4%E6%80%A7%E6%A3%80%E6%9F%A5.png?raw=true)
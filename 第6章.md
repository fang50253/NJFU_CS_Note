# 第六章 文件管理
## 6.1文件和文件系统
### 6.1.1文件、记录、数据项
#### 数据项
* 基本数据项：原子数据，数据元素，字段
* 组合数据项：由若干个基本数据项组成
#### 记录
* 定义：一些有关数据项的集合，描述对象在某方面的属性
* 关键字：唯一能够标志一个记录的数据项
#### 文件
* 有结构文件中，有若干个相关记录组成
* 无结构文件：一个字符流
* 文件是文件系统中**最大**的数据单位
* 文件必须有文件名，由ASCII码或者汉子组成
* 文件类型：源文件、目标文件
* 文件长度：块、字、字节
* 物理位置：指示文件在哪一个设备上以及在该设备的哪个位置的指针
* 建立时间：文件的最后一次修改时间
### 6.1.2文件类型
* 按用途分三类：系统，用户，库文件
* 按文件中数据的形式：源，目标以及可执行文件
* 按存取控制属性：只执行，只读，读写
### 6.1.3文件系统的层次模型
* 对象：文件、目录、磁盘存储空间
* 对对象操纵和管理的软件集合。核心部分包括：文件存储空间的管理，文件目录的管理，逻辑地址与物理地址转换机制，文件读写管理，文件共享与保护等。
* 文件系统的接口：命令(终端键入命令)和程序(系统调用)
### 6.1.4文件操作
* 最基本的文件操作有：创建文件（分配外存，建立目录项）、删除文件（置空目录项）、读文件、写文件、截断文件（原有文件长度置0）和设置文件的读／写位置（改变始终从始端开始读/写操作）
* 文件的“打开”和“关闭”操作：“打开”(open)，是指系统将指名文件的属性（包括该文件在外存上的物理位置）从外存拷贝到内存打开文件表的一个表目中，并将该表目的编号（或称为索引）返回给用户。 “关闭”（close）系统调用来关闭此文件，OS将会把该文件从打开文件表中的表目上删除掉。 
* 其它文件操作：对文件属性的操作，改变文件名、改变文件的拥有者，查询文件的状态等
## 6.2文件的逻辑结构
* 文件由记录构成
* 文件存在两种形式的结构：逻辑结构、物理结构
### 6.2.1文件逻辑结构类型
#### 有结构文件：记录式文件
* 顺序文件
* 索引文件
* 顺序索引文件
#### 无结构文件：字符流
* 流式文件，长度以字节为单位
* UNIX系统中，所有文件都是流式文件
### 6.2.2顺序文件
#### 逻辑记录的排序
* ①串结构，各记录之间的顺序与关键字无关。通常的办法是由时间来决定，即按存入时间的先后排列 
* ②顺序结构，指文件中的所有记录按关键字排列
#### 顺序文件的优缺点
##### 优点: 
* (1)对顺序文件的存取效率是所有逻辑文件中最高的
* (2)只有顺序文件才能存储在磁带上，并能有效地工作
##### 缺点:
* (1)在交互应用的场合，如果用户（程序）要求查找或修改单个记录，为此系统便要去逐个地查找诸记录。 
* (2)如果想增加或删除一个记录，都比较困难。
### 6.2.3记录寻址
* 定长记录的顺序文件：如果已知当前记录的逻辑地址，便很容易确定下一个记录的逻辑地址。在读一个文件时，可设置一个读指针Rptr。令它指向下一个记录的首地址，每当读完一个记录时，便执行:Rptr：=Rptr十L （L为记录长度）
* 变长记录的顺序文件：在每次读或写完一个记录后，须将读或写指针加上Li。Wptr：=Wptr十Li（Li 是刚读或刚写完的记录的长度）
### 6.2.4索引文件
* 原因：对于定长记录，可方便地实现直接存取。对于变长记录就较难实现直接存取，为了解决这一问题，为变长记录文件建立一张索引表，索引表是按键排序的，可以方便地实现直接存取。
### 6.2.5索引顺序文件
* 索引顺序文件:将顺序文件中的所有记录分为若干个组, 为顺序文件建立一张索引表，在索引表中为每组中的第一个记录建立一个索引项，其中含有该记录的键值和指向该记录的指针。
![pic1](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.2.5%E9%A1%BA%E5%BA%8F%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6.png?raw=true)
* 文件检索过程：在对索引顺序文件进行检索时，首先也是利用用户(程序)所提供的关键字以及某种查找算法去检索索引表，找到该记录所在记录组中第一个记录的表项，从中得到该记录组第一个记录在主文件中的位置；然后，再利用顺序查找法去查找主文件，从中找到所要求的记录。
### 6.2.6直接文件和哈希文件
* 直接文件：对于直接文件，可根据给定的记录键值，直接获得指定记录的物理地址。换言之，记录键值本身就决定了记录的物理地址。这种由记录 键值到记录物理地址的转换被称为**键值转换**。
* 哈希（Hash）文件：利用Hash函数，可将记录键值转换为相应记录的地址。为了能实现文件存储空间的动态分配，通常由Hash函数所求得的并非是相应记录的地址，而是指向一目录表相应表目的指针，该表目的内容指向相应记录所在的物理块。 
## 6.3文件目录
* 目录管理的要求：实现“按名存取”、提高对目录的检索速度、文件共享、允许文件重名
### 6.3.1文件控制块和索引结点
#### 文件控制块
* 文件控制块：为了能对一个文件进行正确的存取，必须为文件设置用于描述和控制文件的数据结构，称之为“文件控制块（FCB）” 
* 基本信息：①文件名；②文件物理位置；③文件逻辑结构（表明文件是流式还是记录式，定长还是变长等）；④文件物理结构（顺序文件，链式还是索引文件）
* 存取控制信息类：存取权限
* 使用信息类：文件的简历日期和时间
#### 索引节点
* 索引结点的引入：文件描述信息单独形成一个称为索引结点的数据结构，简称为i结点。在文件目录中的每个目录项，仅由文件名和指向该文件所对应的i结点的指针所构成。
* 磁盘索引结点包括以下内容：文件主标识符，文件类型，存取权限，文件物理地址，文件长度，文件连接计数（系统中所有指向该文件名的指针计数），文件存取时间。
* 内存索引结点包括以下内容：索引结点编号，状态，访问计数，文件所属文件系统的逻辑设备号，链接指针。
### 6.3.2目录结构
![pic1](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.3.2%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png?raw=true)
#### 单级目录结构
* 优点：是简单且能实现目录管理的基本功能——按名存取
* 缺点：查找速度慢、不允许崇明、不便于文件共享只适合单用户环境
#### 两级目录结构
* 实现方法：为每一个用户建立一个单独的用户文件目录UFD，再建立一个主文件目录MFD。在主文件目录中，每个用户目录文件都占有一个目录项，其目录项中包括用户名和指向该用户目录文件的指针
* 优点：提高了检索目录的速度、在不同的用户目录中，可以使用相同的文件名、不同用户还可使用不同的文件名来访问系统中的同一个共享文件
![pic1](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.3.2%E4%B8%A4%E7%BA%A7%E7%9B%AE%E5%BD%95.png?raw=true)
### 6.3.3树形目录结构
![pic1](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.3.3%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84%E7%9B%AE%E5%BD%95.png?raw=true)
* 目录结构：主目录在这里被称为根目录，把数据文件称为树叶，其它的目录均作为树的结点
* 路径名：从树的根（即主目录）开始，把全部目录文件名与数据文件名，依次地用“/”连接起来，即构成该数据文件的路径名（path  name），系统中的每一个文件都有惟一的路径名。
* 当前目录：为每个进程设置一个“当前目录”，又称为“工作目录”进程对各文件的访问都相对于“当前目录”而进行。
* 增加目录：在用户要创建一个新文件时，只需查看在自己的UFD及其子目录中，有无与新建文件相同的文件名。若无，便可在UFD或其某个子目录中增加一个新目录项
* 删除目录：不删除非空目录、可删除非空目录
### 6.3.4目录查询技术
#### 线性检索法
* ①在单级目录中，利用用户提供的文件名，用顺序查找法直接从文件目录中找到指名文件的目录项。
* ②在树型目录中，用户提供的文件名是由多个文件分量名组成的路径名，此时须对多级目录进行查找。 
#### Hash方法
* Hash方法: 建立了一张Hash索引文件目录，系统利用用户提供的文件名并将它变换为文件目录的索引值，再利用该索引值到目录中去查找。
* 优点：Hash方法将显著地提高检索速度。 
* 局限性：在文件名中使用了通配符“* ”、“？”等，系统便无法利用Hash法检索目录，因此，需要利用线性查找法查找目录。  
* Hash查找过程：①在利用Hash值查找目录时，如果目录表中相应的目录项是空的，则表示系统中并无指定文件。②如果目录项中的文件名与指定文件名相匹配，则表示该目录项正是所要寻找的文件所对应的目录项，故而可从中找到该文件所在的物理地址。③如果在目录表的相应目录项中的文件名与指定文件名并不匹配，则表示发生了“Hash冲突”。 
* 解决Hash冲突的方法 ：将其Hash值再加上一个常数（该常数应与目录的长度值互质），形成新的索引值，再返回到第一步重新开始查找。
## 6.4文件共享
* 基于索引结点的共享方式
* 利用符号链实现文件共享 
### 6.4.1基于索引结点的共享方式
![pic1](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.4.1%E5%9F%BA%E4%BA%8E%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%B1%E4%BA%AB%E6%96%B9%E5%BC%8F.png?raw=true)
![pic2](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.4.1%E5%9F%BA%E4%BA%8E%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%B1%E4%BA%AB%E6%96%B9%E5%BC%8F2.png?raw=true)
![pic3](https://github.com/fang50253/NJFU_OS_NoteBook/blob/main/pic/6.4.1%E5%9F%BA%E4%BA%8E%E7%B4%A2%E5%BC%95%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%B1%E4%BA%AB%E6%96%B9%E5%BC%8F3.png?raw=true)
### 6.4.2利用符号链接实现文件共享
* 为使B能共享C的一个文件F，可以由系统创建一个LINK类型的新文件，也取名为F并将F写入B的目录中，以实现B的目录与文件F的链接；在新文件中只包含被创文件F的路径名。这样的链接方法被称为符号链接
* 新文件中的路径名，则只被看作是符号链。当B要访问被链接的文件F且正要读LINK类新文件时，将被OS截获，OS根据新文件中的路径名去读该文件，于是就实现了用户B对文件F的共享
* 在利用符号链方式实现文件共享时，只是文件主才拥有指向其索引结点的指针，而共享该文件的其它用户，则只有该文件的路径名，并不拥有指向其索引结点的指针。
* 符号链方式优点：能连接任何机器上的文件。
* 每增加一个连接，就增加一个文件名，各用户使用自己的名字去共享文件。
* 缺点：备份是可能会产生多个拷贝。
## 6.5文件保护
* 安全性的影响因素：人为因素、系统因素、自然因素
* 采取的措施：存取控制、系统容错技术、建立后备系统
### 6.5.1保护域
#### 访问权
* 对象：硬件、软件
* 对对象施加的操作：读、写、执行
* 访问权：一个进程能对某对象执行操作的权力，用一个有序对（对象名，权集）表示；（F1，{R/W})表示某进程对文件F1执行读和写操作的权力
#### 保护域
* “保护域”简称“域”，是进程对一组对象访问权的集合，进程只能在指定域内执行操作。
#### 进程和域之间的静态联系
* 一一对应，一个进程只联系一个域
#### 进程和域间的动态联系
* 一对多，进程的运行分为若干个阶段，每个阶段联系一个域
### 6.5.2访问矩阵
#### 基本访问矩阵
* 用一个矩阵来描述系统的访问控制，行代表域，列代表对象
* 访问权由资源的拥有者或者管理者决定
#### 具有域切换权的访问矩阵
* 切换作为一种权力，仅当进程有切换权时，才能进行切换
* 增加几个对象作为域，当S∈ACCESS(i，j）时，才允许从i切换到j.
### 6.5.3访问矩阵的修改
* 拷贝权
* 所有权
* 控制权
### 6.5.4访问矩阵的实现
* 访问控制表：对访问矩阵按列划分，为每一列建立一张访问控制表ACL、删除空项
* 访问权限表：对访问矩阵按行划分，为每一行建立一张访问权限表、一个域对每一个对象可以执行的一组操作所构成的表